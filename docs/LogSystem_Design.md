# æ—¥å¿—ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†æ§åˆ¶é¢æ¿é¡¹ç›®çš„æ—¥å¿—ç³»ç»Ÿè®¾è®¡ï¼ŒåŒ…æ‹¬åç«¯æ—¥å¿—æœåŠ¡å’Œå‰ç«¯æ—¥å¿—ç®¡ç†ç•Œé¢ã€‚è¯¥ç³»ç»Ÿæä¾›ç»Ÿä¸€çš„æ—¥å¿—è®°å½•ã€å­˜å‚¨ã€æŸ¥çœ‹å’Œç®¡ç†åŠŸèƒ½ã€‚

## ç³»ç»Ÿæ¶æ„

### åç«¯æ—¥å¿—æœåŠ¡

#### 1. æ—¥å¿—æœåŠ¡æ¨¡å— (LogService)

**æ–‡ä»¶ä½ç½®**: `backend/services/logService.js`

**ä¸»è¦åŠŸèƒ½**:

- ç»Ÿä¸€æ—¥å¿—è®°å½•æ¥å£
- æ—¥å¿—æ–‡ä»¶ç®¡ç†ï¼ˆæŒ‰æ—¥æœŸåˆ†å‰²ï¼‰
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ—¥å¿—æ–‡ä»¶
- æ—¥å¿—çº§åˆ«æ§åˆ¶

**æ—¥å¿—çº§åˆ«**:

- ERROR: é”™è¯¯ä¿¡æ¯
- WARN: è­¦å‘Šä¿¡æ¯
- INFO: ä¸€èˆ¬ä¿¡æ¯
- DEBUG: è°ƒè¯•ä¿¡æ¯

#### 2. æ—¥å¿—å­˜å‚¨ç»“æ„

**å­˜å‚¨è·¯å¾„**: `backend/logs/`

**æ–‡ä»¶å‘½åè§„åˆ™**: `YYYY-MM-DD.log`

**ç¤ºä¾‹**:

```
backend/logs/
â”œâ”€â”€ 2024-01-15.log
â”œâ”€â”€ 2024-01-16.log
â””â”€â”€ 2024-01-17.log
```

#### 3. æ—¥å¿—æ ¼å¼

```
[æ—¶é—´æˆ³] [çº§åˆ«] [æ¨¡å—] æ¶ˆæ¯å†…å®¹
```

**ç¤ºä¾‹**:

```
[2024-01-17 14:30:25] [INFO] [DeviceService] è®¾å¤‡è¿æ¥æˆåŠŸ: device-001
[2024-01-17 14:30:26] [ERROR] [MqttService] MQTTè¿æ¥å¤±è´¥: Connection timeout
```

### API æ¥å£è®¾è®¡

#### 1. æ—¥å¿—è·¯ç”± (LogRoutes)

**æ–‡ä»¶ä½ç½®**: `backend/routes/logs.js`

**æ¥å£åˆ—è¡¨**:

##### GET /api/logs/current

è·å–å½“å‰æ—¥å¿—æµï¼ˆå®æ—¶æ—¥å¿—ï¼‰

**å“åº”**: SSE (Server-Sent Events) æµ

```javascript
// å“åº”æ ¼å¼
data: {
  timestamp: "2024-01-17T14:30:25.123Z",
  level: "INFO",
  module: "DeviceService", 
  message: "è®¾å¤‡è¿æ¥æˆåŠŸ"
}
```

##### GET /api/logs/files

è·å–æ—¥å¿—æ–‡ä»¶åˆ—è¡¨

**å“åº”**:

```json
{
  "files": [
    {
      "filename": "2024-01-17.log",
      "size": 1024576,
      "date": "2024-01-17",
      "lastModified": "2024-01-17T14:30:25.123Z"
    }
  ]
}
```

##### GET /api/logs/download/:filename

ä¸‹è½½æ—¥å¿—æ–‡ä»¶

**å‚æ•°**:

- filename: æ—¥å¿—æ–‡ä»¶å

**å“åº”**: æ–‡ä»¶ä¸‹è½½æµ

### å‰ç«¯æ—¥å¿—ç®¡ç†ç•Œé¢

#### 1. æ—¥å¿—ç®¡ç†é¡µé¢ç»„ä»¶

**æ–‡ä»¶ä½ç½®**: `frontend/src/views/LogManagement.vue`

**ä¸»è¦åŠŸèƒ½**:

- å®æ—¶æ—¥å¿—æŸ¥çœ‹
- å†å²æ—¥å¿—æ–‡ä»¶ç®¡ç†
- æ—¥å¿—æ–‡ä»¶ä¸‹è½½

#### 2. ç»„ä»¶ç»“æ„è®¾è®¡

```
LogManagement.vue (ä¸»é¡µé¢)
â”œâ”€â”€ RealTimeLog.vue (å®æ—¶æ—¥å¿—ç»„ä»¶)
â”œâ”€â”€ LogFileList.vue (æ—¥å¿—æ–‡ä»¶åˆ—è¡¨ç»„ä»¶)
â”œâ”€â”€ LogViewer.vue (æ—¥å¿—æŸ¥çœ‹å™¨ç»„ä»¶)
â””â”€â”€ LogFilter.vue (æ—¥å¿—è¿‡æ»¤ç»„ä»¶)
```

**ç»„ä»¶èŒè´£**:

- **LogManagement.vue**: ä¸»å®¹å™¨ï¼Œç®¡ç†é¡µé¢çŠ¶æ€å’Œç»„ä»¶é€šä¿¡
- **RealTimeLog.vue**: å¤„ç†SSEè¿æ¥ï¼Œæ˜¾ç¤ºå®æ—¶æ—¥å¿—æµ
- **LogFileList.vue**: æ˜¾ç¤ºå†å²æ—¥å¿—æ–‡ä»¶ï¼Œæä¾›ä¸‹è½½åŠŸèƒ½

#### 3. é¡µé¢å¸ƒå±€è®¾è®¡

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ—¥å¿—ç®¡ç†ç³»ç»Ÿ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å®æ—¶æ—¥å¿—] [å†å²æ–‡ä»¶]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  å®æ—¶æ—¥å¿—åŒºåŸŸ (ä¿¡æ¯æµå½¢å¼)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [INFO] 14:30:25 è®¾å¤‡è¿æ¥æˆåŠŸ     â”‚ â”‚
â”‚  â”‚ [WARN] 14:30:26 ç½‘ç»œå»¶è¿Ÿè¾ƒé«˜     â”‚ â”‚
â”‚  â”‚ [ERROR] 14:30:27 MQTTè¿æ¥å¤±è´¥    â”‚ â”‚
â”‚  â”‚ ...                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚  å†å²æ–‡ä»¶åŒºåŸŸ                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“„ 2024-01-17.log (1.2MB) [ä¸‹è½½]â”‚ â”‚
â”‚  â”‚ ğŸ“„ 2024-01-16.log (0.8MB) [ä¸‹è½½]â”‚ â”‚
â”‚  â”‚ ğŸ“„ 2024-01-15.log (1.5MB) [ä¸‹è½½]â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

#### 4. ç»„ä»¶åŠŸèƒ½è¯¦ç»†è®¾è®¡

##### å®æ—¶æ—¥å¿—ç»„ä»¶ (RealTimeLog.vue)

- ä½¿ç”¨ EventSource æ¥æ”¶ SSE æµ
- è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
- æ—¥å¿—çº§åˆ«é¢œè‰²åŒºåˆ†
- æ—¥å¿—è¿‡æ»¤åŠŸèƒ½

##### æ—¥å¿—æ–‡ä»¶åˆ—è¡¨ç»„ä»¶ (LogFileList.vue)

- æ˜¾ç¤ºæ—¥å¿—æ–‡ä»¶åˆ—è¡¨
- æ–‡ä»¶å¤§å°å’Œæ—¥æœŸä¿¡æ¯
- æ–‡ä»¶ä¸‹è½½åŠŸèƒ½

#### 5. è·¯ç”±é…ç½®

**æ–‡ä»¶ä½ç½®**: `frontend/src/router/index.ts`

```javascript
// è·¯ç”±é…ç½®ç¤ºä¾‹
{
  path: '/logs',
  name: 'LogManagement',
  component: () => import('@/views/LogManagement.vue'),
  meta: { title: 'æ—¥å¿—ç®¡ç†' }
}
```

## æŠ€æœ¯å®ç°è¦ç‚¹

### åç«¯å®ç°

#### 1. æ—¥å¿—æœåŠ¡æ ¸å¿ƒåŠŸèƒ½

```javascript
// ä¼ªä»£ç ç¤ºä¾‹
class LogService {
  // è®°å½•æ—¥å¿—
  log(level, module, message) {
    // æ ¼å¼åŒ–æ—¥å¿—
    // å†™å…¥å½“æ—¥æ—¥å¿—æ–‡ä»¶
    // å¹¿æ’­ç»™SSEå®¢æˆ·ç«¯
  }
  
  // è·å–æ—¥å¿—æ–‡ä»¶åˆ—è¡¨
  getLogFiles() {
    // æ‰«ælogsç›®å½•
    // è¿”å›æ–‡ä»¶ä¿¡æ¯
  }
  
  // æ¸…ç†è¿‡æœŸæ—¥å¿—
  cleanOldLogs() {
    // åˆ é™¤7å¤©å‰çš„æ—¥å¿—æ–‡ä»¶
  }
}
```

#### 2. SSE å®æ—¶æ—¥å¿—æ¨é€

```javascript
// ä¼ªä»£ç ç¤ºä¾‹
app.get('/api/logs/current', (req, res) => {
  // è®¾ç½®SSEå“åº”å¤´
  res.writeHead(200, {
    'Content-Type': 'text/event-stream',
    'Cache-Control': 'no-cache',
    'Connection': 'keep-alive'
  });
  
  // ç›‘å¬æ–°æ—¥å¿—äº‹ä»¶
  logService.on('newLog', (logData) => {
    res.write(`data: ${JSON.stringify(logData)}\n\n`);
  });
});
```

### å‰ç«¯å®ç°

#### 1. SSE è¿æ¥ç®¡ç†

```javascript
// ä¼ªä»£ç ç¤ºä¾‹
class LogStreamManager {
  connect() {
    this.eventSource = new EventSource('/api/logs/current');
    this.eventSource.onmessage = (event) => {
      const logData = JSON.parse(event.data);
      this.addLogToDisplay(logData);
    };
  }
  
  disconnect() {
    if (this.eventSource) {
      this.eventSource.close();
    }
  }
}
```

#### 2. æ—¥å¿—æ˜¾ç¤ºä¼˜åŒ–

- è™šæ‹Ÿæ»šåŠ¨å¤„ç†å¤§é‡æ—¥å¿—
- æ—¥å¿—çº§åˆ«é¢œè‰²ç¼–ç 
- è‡ªåŠ¨æ¸…ç†è¿‡å¤šå†å²è®°å½•

## å®ç°æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šåç«¯åŸºç¡€åŠŸèƒ½

1. åˆ›å»ºæ—¥å¿—æœåŠ¡æ¨¡å— (`backend/services/logService.js`)
2. å®ç°æ—¥å¿—è·¯ç”± (`backend/routes/logs.js`)
3. é›†æˆåˆ°ä¸»åº”ç”¨ (`backend/index.js`)
4. åˆ›å»ºæ—¥å¿—å­˜å‚¨ç›®å½•

### ç¬¬äºŒé˜¶æ®µï¼šå‰ç«¯åŸºç¡€ç•Œé¢

1. åˆ›å»ºæ—¥å¿—ç®¡ç†é¡µé¢ (`frontend/src/views/LogManagement.vue`)
2. å®ç°å®æ—¶æ—¥å¿—ç»„ä»¶ (`frontend/src/components/RealTimeLog.vue`)
3. æ·»åŠ è·¯ç”±é…ç½®
4. åˆ›å»ºçŠ¶æ€ç®¡ç†

### ç¬¬ä¸‰é˜¶æ®µï¼šå®Œå–„åŠŸèƒ½

1. å®ç°æ—¥å¿—æ–‡ä»¶åˆ—è¡¨å’Œä¸‹è½½
