# 寸止游戏版本实现差异说明

本文档对比了 **参考版 (12-20.js)** 与 **当前版 (寸止游戏2.js)** 在核心控制逻辑上的主要区别。

## 1. 核心特性对比

| 特性 | 参考版 (12-20.js) | 当前版 (寸止游戏2.js) |
| :--- | :--- | :--- |
| **超压惩罚** | 超过临界值时，仅重置延迟倒计时并触发电击。 | 超过临界值时，**强制归零**强度，进入“过载”状态，必须等待压力回落。 |
| **冷却恢复条件** | 只要压力低于 `criticalPressure`，就开始倒计时 `lowPressureDelay` 秒。 | **更严格**：过载后，压力必须先回落到 `midPressure` (中间压力) 以下，才开始倒计时。 |
| **区间切换** | 简单判断压力区间，低压区实时更新基准强度，高压区直接使用。 | 增加了**“采样保持”**逻辑：显式检测压力从低区进入高区（跨过 `midPressure`）的瞬间，锁定当前强度作为基准，使过渡更平滑。 |

## 2. 代码实现细节

### 2.1 超压惩罚逻辑

**参考版 (12-20.js)**
只要压力超标，立即重置计时器为当前时间 `now`。

```javascript
// Line 210
if(pressure >= cfg.criticalPressure) this._runtime.delayStartTime = now;
```

**当前版 (寸止游戏2.js)**
压力超标时，将 `delayStartTime` 设为 `0`（表示未开始计时状态），并强制强度归零。

```javascript
// Line 214
if (pressure >= cfg.criticalPressure) {
  // ...
  this._runtime.isInDelayPeriod = true;
  this._runtime.delayStartTime = 0; // 设为0，表示计时未开始，需等待满足回落条件
  this._runtime.targetIntensity = 0; // 强制归零
}
```

### 2.2 冷却恢复条件

**参考版 (12-20.js)**
依靠 `delayStartTime` 与 `now` 的差值判断。只要不超压，`delayStartTime` 就不会被重置，自然开始累计时间。

```javascript
// Line 213
if((now - this._runtime.delayStartTime)/1000 < cfg.lowPressureDelay){
  // 处于延迟期
}
```

**当前版 (寸止游戏2.js)**
增加了对 `midPressure` 的判断。只有当 `delayStartTime` 为 0 (处于过载等待状态) 且 压力回落到 `midPressure` 以下时，才记录 `now` 开始计时。

```javascript
// Line 227
if (this._runtime.delayStartTime <= 0 && pressure < cfg.midPressure) {
  this._runtime.delayStartTime = now; // 只有降到 midPressure 以下才开始计时
  // ...
}
```

### 2.3 区间切换 (采样保持)

**参考版 (12-20.js)**
在低压分支中实时更新 `midIntensity`。

```javascript
// Line 262
this._runtime.midIntensity = this._runtime.currentIntensity;
```

**当前版 (寸止游戏2.js)**
引入 `prevPressure`，检测上升沿信号。

```javascript
// Line 271
if (this._runtime.prevPressure < cfg.midPressure && pressure >= cfg.midPressure) {
  this._runtime.midIntensity = this._runtime.currentIntensity; // 仅在跨越瞬间锁定
}
// 并在函数末尾更新 prevPressure
this._runtime.prevPressure = pressure;
```
