## 目标

* 设备映射由“单选”升级为“多选复选”，玩法仍按逻辑设备使用。

* 对逻辑设备的操作广播到所有映射物理设备；监听机制在多设备场景下保持一致、聚合分发。

## 涉及范围

* 前端：`frontend/src/views/GameStartConfigView.vue`

* 后端：`backend/services/gameplayService.js`

## 前端改造

* `deviceMapping` 改为 `Record<string, string[]>`；映射UI改为复选（桌面/移动端）。

* 阻塞校验按数组处理；摘要展示多设备名称。

* 启动请求体按数组提交。

## 后端改造

* `applyDeviceMapping()` 支持字符串/数组，统一存为数组。

* `validateDeviceDependencies()` 必需逻辑设备需至少一个物理设备；逐一校验在线与接口匹配。

* 广播操作：`setDeviceProperty()` 与 `sendDeviceMqttMessage()` 遍历数组下发；`getDeviceProperty()`返回首个设备属性。

* 反向映射展开数组，确保设备上报/属性变更分发到对应逻辑设备。

* 快照返回数组映射。

## 监听机制（补充）

* `listenDeviceMessages(logicalId, callback)`（backend/services/gameplayService.js:33-39）

  * 订阅逻辑设备消息；当任一映射设备上报 `/dpub/{deviceId}`，解析后分发到该逻辑设备的所有回调。

  * 回调签名：`(payloadObj, { logicalId, deviceId, topic })`。

  * 多设备场景：所有映射设备的消息都会触发同一逻辑设备的监听；可通过 `deviceId`区分来源。

* `listenDeviceProperty(logicalId, property, callback)`（backend/services/gameplayService.js:40-48）

  * 订阅逻辑设备指定属性变更；当任一映射设备的数据产生变化，逐属性分发到该逻辑设备的监听。

  * 回调签名：`(newVal, oldVal, { logicalId, deviceId, property })`。

  * 多设备场景：所有映射设备对该属性的变化均触发回调；可用 `deviceId`区分是哪一台变更。

* 分发实现：

  * MQTT消息处理（backend/services/gameplayService.js:322-347）从主题解析 `deviceId`，通过反向映射得到 `logicalId`，调用逻辑设备的消息监听器集合。

  * 设备属性变更处理（backend/services/gameplayService.js:349-378）同样通过反向映射，将每个属性变化分发到逻辑设备对应属性的监听器集合。

## 关键改动位点

* 前端：

  * 数据与映射：frontend/src/views/GameStartConfigView\.vue:341、373-383、422-427

  * 复选控件：frontend/src/views/GameStartConfigView\.vue:74-86、120-133 改为复选

  * 校验：frontend/src/views/GameStartConfigView\.vue:503-553

  * 请求体：frontend/src/views/GameStartConfigView\.vue:568-569

  * 摘要：frontend/src/views/GameStartConfigView\.vue:229-233

* 后端：

  * 映射与校验：backend/services/gameplayService.js:270-311

  * 广播：backend/services/gameplayService.js:49-68、77-83

  * 反向映射：backend/services/gameplayService.js:314-320

  * 快照：backend/services/gameplayService.js:521-528

  * 监听API与分发：backend/services/gameplayService.js:33-48、322-347、349-378

## 兼容

* 若请求体仍为单字符串，后端自动转为单元素数组；玩法无需改动。

## 验证

* 前端映射页可多选设备；摘要正确；阻塞校验符合预期。

* 后端启动后，对逻辑设备的 `sendDeviceMqttMessage()` 与 `setDeviceProperty()`能广播到所有映射设备；消息与属性监听能从所有映射设备收到事件，回调携带来源 `deviceId`。

